Example: Event pattern detection with Apache Flink
==================================================

This example assumes a scenario inspired by IT security or network intrusion detection.
 
Events in streams (generated by devices and services, such as firewalls login-, and
authentication services) are expected to occur in certain patterns. Any deviation from
these patterns indicates an anomaly (attempted intrusion) that the streaming system should
recognize and that should trigger an alert.

The event patterns are tracked per interacting party (here simplified per source IP address)
and are validated by a state machine. The state machine's states define what possible
events may occur next, and what new states these events will result in.

The streaming program that analyzes the event stream is depicted in the diagram below.
The core logic is in the `flatMap` function, which runs the state machines per IP address.

The main class of this example program is `com.dataartisans.flink.streamingdemo.StreamingDemo`


NOTE: The source may be Kafka, but to make this example self-contained, it comes with
a data generator source that produces a sample event stream (with occasional anomalies)
and that can be used without the need to have a Kafka installation.

```
 [ KAFKA-PART-1] --> source --> partition -+---> flatMap(state machine) --> sink
                                            \/
                                            /\
 [ KAFKA-PART-2] --> source --> partition -+---> flatMap(state machine) --> sink
```


The following diagram depicts the state machine used in this example.

```
           +--<a>--> W --<b>--> Y --<e>---+
           |                    ^         |     +-----<g>---> TERM
   INITIAL-+                    |         |     |
           |                    |         +--> (Z)---<f>-+
           +--<c>--> X --<b>----+         |     ^        |
                     |                    |     |        |
                     +--------<d>---------+     +--------+
```


Feedback for this example can be sent to mailto:sewen@apache.org

Docs on Apache Flink can be found at http://flink.apache.org

Check Apache Flink's mailing lists for help on Flink: mailto:user@flink.apache.org


# Cluster testing


Kafka Topic Utils: /usr/hdp/current/kafka-broker/bin/kafka-topics.sh 

/usr/hdp/current/kafka-broker/bin/kafka-topics.sh  --create --topic events-v1 -partitions 120 --replication-factor 1 --zookeeper robert-streaming-m.c.astral-sorter-757.internal:2181,robert-streaming-w-0.c.astral-sorter-757.internal:2181,robert-streaming-w-1.c.astral-sorter-757.internal:2181

/usr/hdp/current/kafka-broker/bin/kafka-console-consumer.sh  --zookeeper robert-streaming-m.c.astral-sorter-757.internal:2181,robert-streaming-w-0.c.astral-sorter-757.internal:2181,robert-streaming-w-1.c.astral-sorter-757.internal:2181 --topic events-v1 --from-beginning



Get consumer offsets

/usr/hdp/current/kafka-broker/bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zkconnect robert-streaming-m.c.astral-sorter-757.internal:2181,robert-streaming-w-0.c.astral-sorter-757.internal:2181,robert-streaming-w-1.c.astral-sorter-757.internal:2181 --topic events-v1 --group standalone-reader


get partition offsets

/usr/hdp/current/kafka-broker/bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list robert-streaming-m.c.astral-sorter-757.internal:6667,robert-streaming-w-0.c.astral-sorter-757.internal:6667 --topic events-v1 --time -1


standalone reader

java -cp target/flink-jobs-0.1-SNAPSHOT.jar com.github.projectflink.streaming.StandaloneKafkaReader --zookeeper.connect robert-streaming-m.c.astral-sorter-757.internal:2181,robert-streaming-w-0.c.astral-sorter-757.internal:2181,robert-streaming-w-1.c.astral-sorter-757.internal:2181 --topic events-v1 --group.id standalone-reader --logfreq 100000 --auto.offset.reset smallest


flink simple reader (equal to standalone reader)

./bin/flink run -c com.github.projectflink.streaming.FlinkKafkaReader -p 1 /home/robert/flink-perf/flink-jobs/target/flink-jobs-0.1-SNAPSHOT.jar --zookeeper.connect robert-streaming-m.c.astral-sorter-757.internal:2181,robert-streaming-w-0.c.astral-sorter-757.internal:2181,robert-streaming-w-1.c.astral-sorter-757.internal:2181 --topic events-v1 --group.id flink-reader --logfreq 1000000 --auto.offset.reset smallest --auto.commit.enable false




Create topic locally:

 ./bin/kafka-topics.sh --create --topic test -partitions 1 --replication-factor 1 --zookeeper localhost:2181

 
